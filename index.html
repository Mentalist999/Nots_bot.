import logging
import json
from datetime import datetime
from dateutil import parser
from telegram import Update, WebAppInfo
from telegram.ext import Application, CommandHandler, ContextTypes, MessageHandler, filters
from telegram import ReplyKeyboardMarkup, KeyboardButton

#–ù–∞—Å—Ç—Ä–æ–π–∫–∏
TOKEN = "8482974728:AAG2iXGMwBpRxAxzIXSt_jLbGq_jZ6_Mf2g"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω!
WEB_APP_URL = "https://mentalist999.github.io/Nots_bot./"  # –í–∞—à–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ GitHub Pages

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)


# ===== –ö–õ–ê–í–ò–ê–¢–£–†–ê –° WEB-APP –ö–ù–û–ü–ö–û–ô =====
def web_app_keyboard():
    return ReplyKeyboardMarkup([
        [KeyboardButton("üìã –û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π", web_app=WebAppInfo(url=WEB_APP_URL))]
    ], resize_keyboard=True, one_time_keyboard=True)


# ===== –ö–û–ú–ê–ù–î–ê /start =====
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.info(f"User {update.effective_user.id} started the bot")
    await update.message.reply_text(
        f"–ü—Ä–∏–≤–µ—Ç, {update.effective_user.first_name}! üéØ\n"
        "–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ —É–¥–æ–±–Ω–æ–º –º–µ–Ω—é.",
        reply_markup=web_app_keyboard()
    )


# ===== –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–• –ò–ó WEB-APP =====
async def handle_web_app_data(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    logger.info(f"Received web app data from user {update.effective_user.id}")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    if not update.message or not update.message.web_app_data:
        logger.warning("No web app data found")
        return

    try:
        # –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON
        data = json.loads(update.message.web_app_data.data)
        logger.info(f"Parsed data: {data}")

        reminder_date = parser.parse(data['date'])
        reminder_text = data['text']

        # –í—ã—á–∏—Å–ª—è–µ–º, —á–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
        now = datetime.now()
        delay = (reminder_date - now).total_seconds()
        logger.info(f"Reminder set for {reminder_date} (in {delay} seconds)")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Ä–µ–º—è –≤ –±—É–¥—É—â–µ–º
        if delay < 0:
            error_msg = "‚è≥ –ù–µ–ª—å–∑—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –ø—Ä–æ—à–ª–æ–º!"
            logger.warning(error_msg)
            await update.message.reply_text(error_msg)
            return

        # –°—Ç–∞–≤–∏–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å
        job_name = f"reminder_{update.effective_chat.id}_{datetime.now().timestamp()}"
        context.job_queue.run_once(
            send_reminder,
            delay,
            chat_id=update.effective_chat.id,
            data=reminder_text,
            name=job_name
        )

        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        success_msg = (
            f"‚úÖ **–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!**\n\n"
            f"**–í—Ä–µ–º—è:** {reminder_date.strftime('%d.%m.%Y –≤ %H:%M')}\n"
            f"**–¢–µ–∫—Å—Ç:** {reminder_text}\n\n"
            f"–Ø –ø—Ä–∏—à–ª—é –≤–∞–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è!"
        )
        await update.message.reply_text(success_msg, parse_mode='Markdown')
        logger.info("Reminder successfully set")

    except (KeyError, ValueError, json.JSONDecodeError) as e:
        error_msg = f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {e}"
        logger.error(error_msg)
        await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")


# ===== –û–ë–†–ê–ë–û–¢–ö–ê –í–°–ï–• –°–û–û–ë–©–ï–ù–ò–ô =====
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –í–°–ï —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    logger.info(f"Received message from user {update.effective_user.id}")

    # –ï—Å–ª–∏ —ç—Ç–æ –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Ö
    if update.message and update.message.web_app_data:
        await handle_web_app_data(update, context)
    else:
        # –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
        await update.message.reply_text(
            "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É 'üìã –û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π' –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º!",
            reply_markup=web_app_keyboard()
        )


# ===== –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø =====
async def send_reminder(context: ContextTypes.DEFAULT_TYPE):
    job = context.job
    logger.info(f"Sending reminder to chat {job.chat_id}")
    await context.bot.send_message(
        job.chat_id,
        text=f"üîî **–ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï**\n\n{job.data}",
        parse_mode='Markdown'
    )


# ===== –ó–ê–ü–£–°–ö –ë–û–¢–ê =====
def main():
    application = Application.builder().token(TOKEN).build()

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
    application.add_handler(CommandHandler("start", start))

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö –∏–∑ WebApp
    application.add_handler(MessageHandler(filters.StatusUpdate.WEB_APP_DATA, handle_web_app_data))

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    logger.info("–ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    application.run_polling()



if __name__ == "__main__":
    main()
